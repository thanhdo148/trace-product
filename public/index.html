<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>H·ªá th·ªëng truy xu·∫•t ngu·ªìn g·ªëc</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>

<style>
body{background:#fff;font-family:Inter,sans-serif}
header{padding:25px;text-align:center;font-weight:600;font-size:22px;border-bottom:1px solid #eee}
.container{width:520px;margin:60px auto;padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.06)}
input{width:100%;padding:14px;margin-bottom:15px;border-radius:12px;border:1px solid #ddd}
button{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-primary:hover{background:#1d4ed8}
.btn-black{background:#000;color:#fff;margin-top:15px}
.result-box{margin-top:20px;padding:20px;border-radius:14px}
.success{background:#f0fdf4;border:1px solid #bbf7d0}
.error{background:#fef2f2;border:1px solid #fecaca}
</style>
</head>

<body>

<header>H·ªÜ TH·ªêNG TRUY XU·∫§T NGU·ªíN G·ªêC</header>

<div class="container">

<h3>K·∫øt n·ªëi v√≠ doanh nghi·ªáp</h3>
<button class="btn-black" onclick="connectWallet()">üîê K·∫øt n·ªëi MetaMask</button>
<p id="walletStatus" style="margin-top:10px;font-weight:500;color:green;"></p>

<hr style="margin:30px 0">

<h3>T·∫°o s·∫£n ph·∫©m</h3>
<input id="code" placeholder="M√£ s·∫£n ph·∫©m">
<input id="name" placeholder="T√™n s·∫£n ph·∫©m">
<input id="origin" placeholder="Xu·∫•t x·ª©">
<input id="date" type="date">
<input id="company" placeholder="T√™n c√¥ng ty">
<button class="btn-primary" onclick="createProduct()">T·∫°o s·∫£n ph·∫©m</button>

<hr style="margin:30px 0">

<h3>Ki·ªÉm tra s·∫£n ph·∫©m</h3>
<input id="verifyCode" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m">
<button class="btn-primary" onclick="verifyProduct()">Ki·ªÉm tra</button>

<div id="result"></div>

</div>

<script>

let signer;
let contract;

const contractAddress = "0x10C1Ccb320A5B55792066105D2926Ed0c6BC1789";


const abi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_code",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_origin",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_date",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_company",
				"type": "string"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_company",
				"type": "address"
			}
		],
		"name": "authorizeCompany",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "authorizedCompanies",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_code",
				"type": "string"
			}
		],
		"name": "getProduct",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];



async function connectWallet(){

    if(!window.ethereum){
        alert("C√†i MetaMask tr∆∞·ªõc!");
        return;
    }

    await window.ethereum.request({ method: "eth_requestAccounts" });

    const provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();

    contract = new ethers.Contract(contractAddress, abi, signer);

    const address = await signer.getAddress();

    document.getElementById("walletStatus").innerText =
        "‚úÖ ƒê√£ k·∫øt n·ªëi: " + address.slice(0,6) + "..." + address.slice(-4);
}

async function createProduct(){

    if(!contract){
        alert("K·∫øt n·ªëi v√≠ tr∆∞·ªõc!");
        return;
    }

    const code = document.getElementById("code").value;
    const name = document.getElementById("name").value;
    const origin = document.getElementById("origin").value;
    const date = document.getElementById("date").value;
    const company = document.getElementById("company").value;

    if(!code || !name || !origin || !date || !company){
        alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        return;
    }

    try{

        const tx = await contract.addProduct(
            code,
            name,
            origin,
            date,
            company
        );

        await tx.wait();

        alert("üéâ T·∫°o s·∫£n ph·∫©m th√†nh c√¥ng!");

    }catch(err){
        console.log(err);
        alert("L·ªói: " + (err.reason || err.shortMessage || err.message));
    }
}

async function verifyProduct(){

    const code = document.getElementById("verifyCode").value;
    const resultBox = document.getElementById("result");

    if(!code){
        alert("Nh·∫≠p m√£ s·∫£n ph·∫©m");
        return;
    }

    try{

        // üî• D√ôNG RPC PUBLIC ‚Äì KH√îNG C·∫¶N METAMASK
        const provider = new ethers.JsonRpcProvider(
            "https://sepolia.infura.io/v3/5c3bb9d618ef44668a2979a898fb28ce"
        );

        const readContract = new ethers.Contract(
            contractAddress,
            abi,
            provider
        );

        const result = await readContract.getProduct(code);

        const [name, origin, manufactureDate, company, exists] = result;

        if(!exists){
            resultBox.innerHTML =
                `<div class="result-box error">‚ùå Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
            return;
        }

        resultBox.innerHTML = `
            <div class="result-box success">
                <h3>‚úÖ S·∫¢N PH·∫®M H·ª¢P L·ªÜ</h3>
                <p><b>M√£ s·∫£n ph·∫©m:</b> ${code}</p>
                <p><b>T√™n s·∫£n ph·∫©m:</b> ${name}</p>
                <p><b>Xu·∫•t x·ª©:</b> ${origin}</p>
                <p><b>Ng√†y s·∫£n xu·∫•t:</b> ${manufactureDate}</p>
                <p><b>C√¥ng ty:</b> ${company}</p>
            </div>
        `;

    }catch(err){
        console.log(err);
        resultBox.innerHTML =
            `<div class="result-box error">‚ùå L·ªói ki·ªÉm tra</div>`;
    }
}

</script>

</body>
</html>
